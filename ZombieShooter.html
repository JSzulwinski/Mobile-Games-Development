<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
    <style>
       #startBtn
        {
            position: absolute;
            top: 400px;
            left: 300px;
            width: 100px;
            height: 60px;
            font-size: 25px;   
        }
        #restartBtn
        {
            position: absolute;
            top: 400px;
            left: 300px;
            width: 150px;
            height: 60px;
            font-size: 25px;   
        }
    </style>
</head>
<body>
<canvas id="canvasForTheGame"></canvas>
<button type="button" id="restartBtn" onclick="restartGame()">REPLAY</button>
<button type="button" id="startBtn" onclick="startGame()">START</button>
<script>
    var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
	window.requestAnimationFrame = requestAnimationFrame;
       
    var canvas = document.getElementById("canvasForTheGame");
	var width = 700;
	var height = 700;
	var ctx = canvas.getContext("2d");
	var player = 
    {
		x: width / 2,
		y: height - 200,
		width: 45,
		height: 45,
		velX: 0,
		velY: 0,
        hp:20,
        attackCounter:0,
        aimAngle:0,
	};
    
    var imgCrate = new Image();
    var boxes = [];

	var keys = [];
	var friction = 0.8;

	canvas.width = width;
	canvas.height = height;
    
    var startBtn = document.getElementById('startBtn');
    var paused = false;
    var isGameOver = false;
    var test = false;
    var timeGameStarted = Date.now();
    var score;
    var stamina = 500;
    var playerSpeed;
    var shootDirection;
    var timeSurvived = 0;
    var startTimeMS = 0;
    var frameX = 0;
    var frameXMax = 1;
    var frameY = 0;
    var frameYMax = 1;
    var frame = 0;
    var frameMax = 26;
    var frameTimer = 0.05;
    var frameTimeMax = 0.017;
    var frameCount = 0;
    var spriteWidth = 32;
    var spriteHeight = 32;
    var img = new Image();
    var enemyImg = new Image();
    var bulletImg = new  Image();
    var upgradeImg = new Image();
    var mapImg = new Image();
    var mapTitle = new Image();
    var zombieImg = new Image();
    var music = new Audio();
    var shotSound = new Audio();
    var hitSound = new Audio();
    var damageSound = new Audio();
    
    var mouseX;
    var mouseY;

    var mouseDown = false;
    var isKeyPressed = false;
    
    var gameStarted = false;
    
    var staminaRatio = 0;
    var sprinting = false;
    
    //Lists    
    var enemyList = {};
    var bulletList = {};
    var upgradeList = {};
    var zombieList = {};
    
    
    function start()
    {
        restartGame();
        
        gameStarted = false;
        stamina = 500;
        sprinting = false;
        
        imgCrate.src = 'block.png';
        img.src = 'spriteSheet.png';
        mapTitle.src = 'title.png';
        enemyImg.src = 'soldier.png';
        bulletImg.src = 'bullet.png';
        mapImg.src = 'floor.png';
        upgradeImg.src = 'upgrade.png';
        music.src = 'music.mp3';
        shotSound.src = 'gun.mp3';
        hitSound.src = 'hit.mp3';
        damageSound.src = 'damage.mp3';
        zombieImg.src = 'zombie.png';
         
		canvas.width = width;
		canvas.height = height;

		ctx.font = "30px LLPixel";
		ctx.fillStyle = "green";
		ctx.textAlign = "center";
		ctx.fillText("HP: " + player.hp, 30, 30);
        ctx.fillText("Score: " + score, 580, 30);
        ctx.fillRect(30, 80, staminaRatio, 15);
        
        isGameOver = false;
        paused = false;   
        playerSpeed = 0.8;
    }
    
    function startGame()
    {
        music.play();
        gameStarted = true;
    }
    
    
    function Enemy(id,x,y,spdX,spdY,width,height){
        var enemy = {
                x:x,
                spdX:spdX,
                y:y,
                spdY:spdY,
                width: width,
                height: height,
                name:'E',
                id:id,
        };
        enemyList[id] = enemy;
    }
    
    function Bullet(id,x,y,spdX,spdY,width,height){
        var bullet = {
                x:x,
                spdX:spdX,
                y:y,
                spdY:spdY,
                width: width,
                height: height,
                name:'E',
                id:id,
                color:'black',
                timer:0,
        };
        bulletList[id] = bullet;
    }
    
    function Zombie(id,x,y,width,height){
        var zombie = {
                x:x,
                y:y,
                width: width,
                height: height,
                name:'E',
                id:id,
        };
        zombieList[id] = zombie;
    }
    
    function generateEnemy(){
        var id = Math.random();
        var x = Math.random()*650;
        var y = Math.random()*600 + 50;
        var spdX = 3*Math.random();
        var spdY = 3*Math.random();
        var height = 10 + Math.random()*30;
        var width = 10 + Math.random()*30;   
        Enemy(id,x,y,spdX,spdY,width,height);
    }
    
    function generateZombie(){
        var id = Math.random();
        var x = Math.random()*650;
        var y = Math.random()*600 + 50;
        var height = 10 + Math.random()*30;
        var width = 10 + Math.random()*30;   
        Zombie(id,x,y,width,height);
    }
    
    function generateBullet(){
        var id = Math.random();
        var x = player.x+18;
        var y = player.y+18;
        var height = 7;
        var width = 7;
        var angle = player.aimAngle;
        var spdX = Math.cos(angle/180*Math.PI)*8;
        var spdY = Math.sin(angle/180*Math.PI)*8;
        Bullet(id,x,y,spdX,spdY,width,height);
    }
    
    //PAUSE FUNCTION
    
    document.onkeydown = function(event){
        if(event.keyCode === 80)
        {
            if(paused === true)
                {
                  paused = false;
                return update();
                }
            else if (paused ===false)
                {
                    paused = true;          
                }

        }
        if(event.keyCode === 69)
        {
            
        }
                
    }
    
    //SHOOTING
    document.onmousedown = function(mouse)
    {
        mouseDown = true;
    }
    
    document.onmouseup = function(mouse)
    {
        mouseDown = false;
    }
    
    function attack()
    {
        if(player.attackCounter > 50)
        { 
            generateBullet();
            player.attackCounter = 0;
            shotSound.play()
        }
    }
     
    //MOUSE POSITION
    document.onmousemove = function(mouse){
        mouseX = mouse.clientX;
        mouseY = mouse.clientY;
       
        mouseX -= player.x +19;
        mouseY -= player.y +19;
        
        player.aimAngle = Math.atan2(mouseY, mouseX)/Math.PI*180;

    }
    
    //ENEMY1 UPDATE ENTITIY
    function updateEntity(something){
        something.x += something.spdX;
        something.y += something.spdY;

        ctx.drawImage(enemyImg, something.x, something.y);
                      
        if(something.x < 0 || something.x > (width - 40)){
                something.spdX = -something.spdX;
        }
        if(something.y < 60 || something.y > (height-40)){
                something.spdY = -something.spdY;
        }      
    }
    
    function updateZombieEntity(other){
        
        var targetX = player.x - other.x;
        var targetY = player.y - other.y;
            
        other.rotation = Math.atan2(targetY, targetX);
        //ctx.transform(1, 0, 0, 1, this.x, this.y);
   
        ctx.save()
        ctx.translate(other.x, other.y);
        ctx.rotate(other.rotation + 1.5);
        ctx.drawImage(zombieImg, -17, -17);
        ctx.restore();
        
        if(targetX > 0)
        {
            other.x += 2;
        }
        else
        {
            other.x -= 2;  
        }
        
        if(targetY > 0)
        {
            other.y += 2;
        }
        else
        {
            other.y -= 2;  
        }
                      
        if(other.x < 0 || other.x > (width - 40)){
                
        }
        if(other.y < 60 || other.y > (height-40)){
                
        }      
    }
    
    //UPDATE ENTITY OTHER THAN ENEMY 
    function updateEntityOther(something, somethingImg){
        something.x += something.spdX;
        something.y += something.spdY;

        ctx.drawImage(somethingImg, something.x, something.y);
                        
    }

    

    window.addEventListener("load", function (){
        start();
        update();
	});
    
    document.body.addEventListener("keydown", function (e) {
		keys[e.keyCode] = true;
		isKeyPressed = true;
	});
    
    document.body.addEventListener("keyup", function (e) {
		keys[e.keyCode] = false;
		isKeyPressed = false;
	});
   
    function rtate()
    {
        ctx.save();
        ctx.translate(player.x + 20, player.y + 20);
        ctx.rotate(player.aimAngle * Math.PI / 180 - 1.7);
        ctx.drawImage(img, 0, 32, spriteWidth, spriteHeight, -19, -19, player.width, player.height);
        //ctx.translate(-10, -10);
        ctx.restore();
    }
        
    function update()
    {     
        if(paused)
        {
            ctx.fillText('Paused', width/2, height/2);
            return;
        }    
        ctx.clearRect(0, 0, width, height); 
        
        if(gameStarted === false)
        {
            drawTitle();
            requestAnimationFrame(update);
        }
 
        else if (gameStarted === true)
        {
            drawMap();
            startBtn.style.display = 'none';
            
        if (isGameOver === false)   
        {
            ctx.fillText("HP: " + player.hp, 50, 30); 
            ctx.fillText("Score: " + score, 580, 30);
            ctx.fillRect(130, 10, staminaRatio, 25);
            
            score++;
            
            frameCount++;
        
            if(frameCount % 60 === 0)
               generateEnemy();
            
            if(frameCount % 100 === 0)
                generateZombie();
        
            
            player.attackCounter += 5;
        }
        else if (isGameOver === true) 
        {
            ctx.fillText("YOU DIED. SCORE: " + score, 350, 30);
            restartBtn.style.display = 'block';
        }
            
        staminaRatio = 100*stamina/500;
            
        for(var key in boxes)     
            {
                boxes[key].x = boxes[key].posX
                boxes[key].y = boxes[key].posY
            }
        
        for(var key in enemyList){
            
            updateEntity(enemyList[key]);
            
            var dir = colCheck(player, enemyList[key]);

			if (dir === "l" || dir === "r") {
                delete enemyList[key];
                player.hp -= 1
                hitSound.play();
			} else if(dir === "t" || dir === "b"){
                delete enemyList[key];
                player.hp -= 1
                hitSound.play();
			}
            timeSurvived = Date.now() - timeGameStarted;
        }
            
        for(var key in zombieList){
            
            updateZombieEntity(zombieList[key]);
            
            var dir = colCheck(player, zombieList[key]);

			if (dir === "l" || dir === "r") {
                delete zombieList[key];
                player.hp -= 1
                hitSound.play();
			} else if(dir === "t" || dir === "b"){
                delete zombieList[key];
                player.hp -= 1
                hitSound.play();
			}
            timeSurvived = Date.now() - timeGameStarted;
        }
        
        
        //BULLET
        
        for(var key in bulletList){
            updateEntityOther(bulletList[key], bulletImg); 
            
            var toRemove = false;
            
            bulletList[key].timer++;
            if(bulletList[key].timer > 100)
                {   
                    toRemove = true;
                }
            
            for(var key2 in enemyList)     
            {
                var dir = colCheck(enemyList[key2], bulletList[key]);
                
                if (dir === "l" || dir === "r") 
                {
                    toRemove = true;
                    delete enemyList[key2];
                    damageSound.play();
                    break;
                }       
                if(dir === "t" || dir === "b")
                {
                    toRemove = true;
                    delete enemyList[key2]; 
                    damageSound.play();
                    break;
			
                }               
            }
            
            for(var key2 in zombieList)     
            {
                var dir = colCheck(zombieList[key2], bulletList[key]);
                
                if (dir === "l" || dir === "r") 
                {
                    toRemove = true;
                    delete zombieList[key2];
                    damageSound.play();
                    break;
                }       
                if(dir === "t" || dir === "b")
                {
                    toRemove = true;
                    delete zombieList[key2]; 
                    damageSound.play();
                    break;
			
                }               
            }
            
            for(var key2 in boxes)     
            {
                var dir = colCheck(boxes[key2], bulletList[key]);
                
                if (dir === "l" || dir === "r") 
                {
                    toRemove = true;
                    break;
                }       
                if(dir === "t" || dir === "b")
                {
                    toRemove = true;  
                    break;
			
                }               
            }
            
            if (toRemove)
                {
                    delete bulletList[key];	
                }
        }
        
        
        if (player.hp <= 0)
        {
                            
        isGameOver = true;
        player.hp = 20;
        enemyList = {};
        bulletList = {};
        upgradeList = {};
        }  
        
        animationFrame();
        if (isKeyPressed == false)
        {	
                    //music.play();
            rtate();
        }
        if (isKeyPressed == true)
        {	
            music.play();
        }

        //SHOOTING
        if(mouseDown === true)
        {
            attack();
        }
        
        //MOVE DIRECTION
        
        if (keys[83]) {
			// S Key
			if(player.y<(canvas.height-player.height-40))
				player.velY += playerSpeed;
            rtate();
		}
		if (keys[87]) {
			// W Key
			if(player.y>80)
				player.velY -= playerSpeed;
            rtate();
		}
		if (keys[68]) {
			// D Key
			if(player.x<(canvas.width-player.width-40))
				player.velX += playerSpeed;
            rtate();
		}
		if (keys[65]) {
			// A Key
			if(player.x>player.width)
				player.velX -= playerSpeed;
            rtate();
		}
        
        //ROTATE
        if (keys[71]) 
        {
            rtate();
		}
            
        //SPRINT
        if (keys[16])
        {
            if (stamina > 0)
            {
            playerSpeed = 1.5;
            stamina-= 2;
            sprinting = true;
            }
            else
        {
            sprinting = false;
            playerSpeed = 0.8;
        } 
        }
        
            
        if (sprinting === false)
        {
            if(stamina < 500)
            {
                stamina +=0.5;
            }
        }
            
        //console.log(stamina);
        
        player.velX *= friction;
		player.velY *= friction;
		player.x += player.velX;
		player.y += player.velY;


		requestAnimationFrame(update);
        
        //ENABLE BOXES
        
        for (var i = 0; i < boxes.length; i++) 
        {
            //boxes[i].x = Math.random()*650/*canvas.width*/;
            //boxes[i].y = Math.random()*650;
            
			// show the boxes on canvas
			ctx.rect(boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);
			ctx.drawImage(imgCrate, boxes[i].x, boxes[i].y, boxes[i].width, boxes[i].height);
			// check if collide with players
			var dir = colCheck(player, boxes[i]);

			if (dir === "l" || dir === "r") {
				player.velX = 0;
			} else if(dir === "t" || dir === "b"){
				player.velY = 0;
			}
            
            for(var key2 in enemyList)     
            {
                var dir = colCheck(enemyList[key2], boxes[i]);
                
                if (dir === "l" || dir === "r") 
                {
                    enemyList[key2].spdX = -enemyList[key2].spdX;
                    break;
                }       
                if(dir === "t" || dir === "b")
                {
                    enemyList[key2].spdY = -enemyList[key2].spdY;
                    break;
			
                }               
            }
            
            for(var key2 in zombieList)     
            {
                var dir = colCheck(zombieList[key2], boxes[i]);
                
                if (dir === "l" || dir === "r") 
                {
                    break;
                }       
                if(dir === "t" || dir === "b")
                {
                    break;
			
                }               
            }
            
            
		}
        }
    }
    
    function colCheck(shapeA, shapeB) {
		// get the vectors to check against
		var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
			vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
			// add the half widths and half heights of the objects
			hWidths = (shapeA.width / 2) + (shapeB.width / 2),
			hHeights = (shapeA.height / 2) + (shapeB.height / 2),
			colDir = null;

		// if the x and y vector are less than the half width or half height, they we must be inside the object, causing a collision
		if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
			// figures out on which side we are colliding (top, bottom, left, or right)
			var oX = hWidths - Math.abs(vX),
				oY = hHeights - Math.abs(vY);
			if (oX >= oY) 
            {
				if (vY > 0) {
					colDir = "t";
					shapeA.y += oY;
				} else {
					colDir = "b";
					shapeA.y -= oY;
				}
			} 
            else 
            {
				if (vX > 0) {
					colDir = "l";
					shapeA.x += oX;
				} else {
					colDir = "r";
					shapeA.x -= oX;
				}
			}
		}
		return colDir;      
	}	
        
    function animationFrame(){
		var elapsed = (Date.now() - startTimeMS)/1000;
		startTimeMS = Date.now();

		//only update frames when timer is below 0
		frameTimer = frameTimer - elapsed;
		if(frameTimer <= 0)
		{
			frameTimer = frameTimeMax;
			frameX++;
			if(frameX>frameXMax)
			{
			  frameX = 0;
			  frameY++;
			  //end of row, move down to next row in sheet
			  if(frameY>frameYMax)
			  {
				  frameY = 0;
			  }
			}
			frame++;
			//reset frames to 0 in event that there are empty spaces on sprite sheet
			if(frame > frameMax)
			{
			  frame = 0;
			  frameX = 0;
			  frameY = 0;
			}
		}
    }
    
    function drawMap()
    {
        ctx.drawImage(mapImg, 0, -40, 2000, 2000, 0, 0, mapImg.width*3, mapImg.height*3);
    }
    function drawTitle()
    {
        ctx.drawImage(mapTitle, 0, -40, 2220, 2220, 0, 0, mapImg.width*3, mapImg.height*3);
    }
    
    function restartGame()
    {
        boxes = [];
        boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        boxes.push({
            posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*600+60,
			width: 40,
			height: 40
		});
		boxes.push({
			posX: Math.random()*650,
			posY: Math.random()*550+60,
			width: 40,
			height: 40
		});
        player.hp = 20;
        timeGameStarted = Date.now();
        frameCount = 0;
        enemyList = {};
        score = 0;
        bulletList = {};
        //upgradeList = {};
        generateEnemy();
        generateEnemy();
        generateEnemy(); 
        generateZombie(); 
        restartBtn.style.display = 'none';
        isGameOver = false;
        

    }
    

</script>
</body>
</html>
